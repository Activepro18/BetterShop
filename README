BetterShop - The "better" global command-based shop that ties into iConomy

active developers: jascotty2 & jjfs85
===============================================================================
In-Game Commands:
===============================================================================

/shop							for those used to a plugin having one command, this is another way to get to the following
/shophelp (shelp)					shows you all the commands you can use
/shoplist (sl,slist)		[pagenum]		shows a listing of items for sale (if -1, all, or full given, will show full list. (for console use))
/shopitems (sitems)					show full listing of items in shop, without prices
/shopcheck (sc,scheck) 		<item>			lookup a specific item so you don't have to read through pages of prices
/shopbuy (buy,sbuy) 		<item> [amount]		buy an item for the price in the shopshop ("all" is accepted as an amount)
/shopbuyall (buyall,sbuyall) 	<item> 			buy all of an item that you can hold
/shopsell (sell,ssell)   	<item> [amount]		sell an item for the price in the shop
/shopadd (sadd): 		<item> <buy> [sell]	add an item to or update an item in the price list
/shopremove (sremove): 		<item>			remove an item from the price list
/shopload (sload): 					reload prices from pricelist database
/shopsellall (sellall):		<item> [item [...]]	Sell all of item from your inventory (alias to command /shop sell all)
/shopbuystack (buystack): 	<item> [item | amount]	buy a stack of an item (usually 64)
/shopbuyagain (buyagain,sba): 				repeat last buy action
/shopsellagain (sellagain,ssa): 			repeat last sell action
/shopkits (skits):					show a listing of avalliable kits (will be elaborated later)


===============================================================================
Features:
===============================================================================

=== plugin support
currently dependent on iConomy
Permissions support

=== configurable
Fully configurable colors and message text in config.yml file
shoplist can have text alignment (read config for more info): <item> <l(eft-aligned)> <buy and sell info>
- uses minecraft font character spacing, so is very close to perfectly aligned in chat
shoplist can optionally not show listing tail (or head, but recommended to leave <page> of <pages>)
Items can be colored in the new itemsdb.yml file
also in itemsdb.yml: kits!
- define your own kits that the shop can sell
- three expamples provided, edit and add to your liking
Configurable Options:
-max pagesize when printing shoplist
-whether to broadcast all transactions publicly
-name of the pricelist file/table
-customsort: a custom sorting order, so you can have items at the top of the shop list
-allowbuyillegal: if someone without BetterShop.admin.illegal can buy illegal items
-whether maxstack should be honored
-if used tools can be bought back

=== shop flexibility
shopcheck will run a name comparison check, and return all matching items
Item sub-type support for dye colors, cloth colors, etc: magentacloth = 35:2 = cloth:magenta
"all" is a valid amount when buying or selling: "/sell cobblestone all" or "/sell all cobblestone"
damaged tools can be resold for an adjusted value of sellprice*(1-(damage/maxdamage))
buystack can be given multiple items, or number of stacks: "/buystack wool 5" or "/buystack wool blackdye reddye"
shopsellall can be given multiple items (/sell all cobble gravel flint dirt)

=== administration
Every item and subtype can be priced differently
Disable buying or selling of an item by giving it a price of -1	 (0 makes it free)
command aliases to stop carpal tunnel
many commands have sub-aliases.. eg. shoplist kits will run shoplistkits
MySQL pricelist support 
MySQL pricelist can be cached for a given timespan (decreases table selects) (flatfile is cached until manually updated)
Transaction records (MySQL only right now)
Downloads mysql-bin.jar dependency automatically
buy/sell cap in program set to 999,999,999 (not that you'd be using that much, but the cap is to prevent other errors)
if encounters errors while editing a player's account, will attempt to reload iConomy (i've had issuses with it before)


There are two ways to add things to the shop:
Recommended, but slow: use /shopadd [item] [buy-price] [sell-price]
Faster: use a text editor (or spreadsheet program) to add items to the BetterShop.csv file. 
	items are in this order: id, subdata, buy, sell, name
	item id & subdata are checked against itemsdb.yml, and are removed if they don't exist
	for your convinence, you can use names (not subnames, though), so "wool,blue,1,-1" is a valid entry
	The name value is there only for human readability, it's not read by the plugin.

===============================================================================
Permissions:
===============================================================================
Just add the following nodes to Permissions' config.yml file (or data.yml file for GroupManager):

BetterShop.user.*	Allows the user to use the list, sell, buy, and help commands
BetterShop.admin.*	Allows the user to use the add, remove, and load commands

There are other nodes that allow only more specific permissions, but I recommend using the above.

BetterShop.user.list		look through shop listing of prices
BetterShop.user.check		check the price of item(s)
BetterShop.user.help		view ingame help menu
BetterShop.user.buy		buy items from the shop
BetterShop.user.sell		sell items to the shop
BetterShop.admin.add		add/edit items to/in the shop
BetterShop.admin.remove		remove items from the shop
BetterShop.admin.load		reload configuration & pricelist
BetterShop.admin.info		show shop stats (only version number right now)
BetterShop.admin.illegal	gives the ability to purchase 'illegal' items

===============================================================================
TODO (items are removed as they're added)
===============================================================================

calculated/derived item prices
/shopvalue item[@amount] item  to show the current trade value for two items
discount system: users or groups can be charged less/more for an item or all items (sell prices also affected)
more descriptive kit listing, similar to shoplist
add flatfile support for transaction logging
dynamic market pricing, based off of logged market activity
region shops (items added while in a region defined as a shop are only added to that shop)
stock option - BetterShop.admin.stock to update how much stock the shop has
	- selling to the shop increases the stock
		- also descreases how much item is worth to the shop (optional, not influenced by market activity)


=== Removed (not going to implement)
persistentMySQL: if false, will disconnect from db when now using it (use if have a high cacheUpdate)
		(the MySQL connection is now shared with other features, so disonnecting could cause more performance issues)

===============================================================================
Changelog:  (the (?) means plugin didn't report that as the version.. sorry :))
===============================================================================

Version 1.6.1 - ? - jascotty2
[]added flatfile support for transaction logging
[]stock option - BetterShop.admin.stock to update how much stock the shop has
[]	- selling to the shop increases the stock
][		- also descreases how much item is worth to the shop (optional, not influenced by market activity)

Version 1.6.1 alpha - 3/18/11 - jascotty2
Checks git to see if there is a newer version avaliable (todo: config & download update?)
fixed price = 0 to be free
fixed null in sellall if selling all sellable


Version 1.6.0f - 3/18/11 - jascotty2
better error check for config & importing old yml pricelist
MySQL pricelist can be cached for a given timespan (decreases table selects)
fixed sell bug (selling one would credit for amount in the first stack)


Version 1.6.0e - 3/17/11 - jascotty2
fixed a removal error - there was a typecast exception previously


Version 1.6.0d - 3/17/11 - jascotty2
if the old PriceList.yml file exists, will import into whatever db is enabled, then rename the file
fixed public message bug - would send broadcast (num players-1) times


Version 1.6.0c (?) - 3/17/11 - jascotty2
added more options:  allowbuyillegal, usemaxstack, buybacktools
fixed buystack history
major buystack logic error repaired - previously didn't work correctly
buystack can now be given multiple items, or number of stacks: "/buystack wool 5" or "/buystack wool blackdye reddye"
damaged tools can now be resold for an adjusted value of sellprice*(1-(damage/maxdamage))


Version 1.6.0b (?) - 3/16/11 - jascotty2
fixed a minor buy error if tried to buy more than they can hold, and could hold 0 more
major MySQL problem fixed - pricelist table wasn't being created


Version 1.6.0 - 3/16/11 - jascotty2
major code restructure & reorganization 
changed item db to a more descriptive yml file
- can define what items make an item (for calculated/dynamic costs)
- can change what color it will be outputted as in the listing
- define kits (sold.. store won't buy them)
MySQL buy & sell fields increased to decimal(11,2), and cap in program set to 999,999,999
shoplist can now optionally not show listing tail (or head, but recommended to leave <page> of <pages>)
removed value check - can now "sell" items that sell for 0 
added /shop command alias - for if a user is more used to "/shop help" than "/shophelp"
many commands have sub-aliases.. eg. shoplist kits will run shoplistkits
now does pre-check for if user can hold as much as they're trying to buy
-	and "all" to try to buy as many as they can hold
items can be marked as illegal, and can only be purchased by a select few (using permissions)
-	also not shown to users who cannot buy them, except with pricecheck
option in config to make transactions publicly broadcasted
option in config to have a custom sort order
shopsellall can be given multiple items (/sell all cobble gravel flint dirt)
now shows what items were sold when using shopsellall
fixed bug where single sell parameter would == sell [item] all
all, full, -1 added as a pricelist pagenumber: will print the full list (intended for console use)
marketactivity table truncate logic repaired.. 
marketactivity MySQL table changed with primary key(DATE, USER, ID) (instead of DATE, USER) to resolve conflits with sellall
items can be marked as 'legal: false', and only those with permissions can buy them (can still sell)
if encounters errors while editing a player's account, will attempt to reload iConomy
sellall can be given "inv" as first parameter to only sell from inventory (not in quick access slots)
shopcheck given partial name matching: "/shopcheck wool" (not "shopcheck 35") will show all colored wool prices :)
fixed sellall bug when an item not for sale
/shopbuystack (buystack): 	buy a stack of an item (usually 64)
/shopbuyagain (buyagain,sba): 	repeat last buy action
/shopsellagain (sellagain,ssa): repeat last sell action
/shopkits (skits):		show a listing of avalliable kits (will be elaborated later)
can now buy kits :)
/add now has sell as an optional parameter.. will set to -1 if not given (or if is a kit)


Version 1.5.9b - 3/11/11 - jascotty2
width outputting in minecraft chat (for /shoplist): now can have item (or listing) right-align, left-align, or centered
implemented transaction log and total transactions record
no longer dependent on permissions: if missing, ops have .admin.* & everyone has .user.*
bugs: MySQL buy & sell is decimal(6,2), limiting price to 9,999 (plus a nondescriptive error)
	- to fix (db minecraft, table BetterShop): 
		alter table minecraft.BetterShop change column buy buy decimal(11,2);
		alter table minecraft.BetterShop change column sell sell decimal(11,2);
     unkown error: MySQL connection seems to get dropped & won't connect until restart plugin
		seems to stem from iConomy (v4.4 (Arcadia)) or v0.2 [Coelho].. i only have 4.4, but .2 is being logged
		shopload should fix this, but iconomy will still be down.. if you have a plugin like hotswap, reload iConomy
     not a bug, but forgot to remove: logs select statements being executed

Version 1.5.8(?) - 3/10/11 - jascotty2
fixed a sell error for one parameter
major-ish code restructure - removed data redundancy
/ shopsell all [item] (alias to /shopsell [item] all)


Version 1.5.7(?) - 3/10/11 - jascotty2
/ shopsell [item] all added: sell all of an item that you have
fixed total sell value min to .01 instead of 1 (if your server uses low prices)
	before this fix, one could get around this check by trying to sell alot of an item
now automatically downloads mysql dependency (zip from mysql mirror & unzip or from iConomy mirror)


Version 1.5.5(?) - 3/9/11 - jascotty2
Pricelist can now be in a MySQL database


Version 1.5.4 - 3/2/11
Fixed some lingering bugs with lologarithm's help.


Version 1.5.3
Fixed sell 0 < sellprice < 1 bug.


Version 1.5.2
Now it'll convert your old pricelist.yml to the new 1.5.x format automagically!


Version 1.5.1
Fixed the bug where setting a price to -1 didn't disable it
Fixed the "LOLWTFDOESN'TWORK" bug. 
Made price-list listing configurable in config.yml. The way it was 'sposta be.

(older versions not shown..)

===============================================================================
Building
===============================================================================

To build, you need to include the following as libraries:
    bukkit.jar	(current build used git-Bukkit-0.0.0-516-gdf87bb3-b531jnks (MC: 1.3))
    iConomy.jar	(4.4.7)
    Permissions.jar 

If you want helpful bukkit javadocs, you should get:
    the Bukkit source code

Once it builds, compress on linux using:
    jar or an equivalent archiver
      jenny:~/workspace/BetterShop/bin$ jar -cf BetterShop.jar *

or on Windows using:
    I have no clue. I guess something similar to jar.

And it's ready to be placed in a plugins directory :)

